<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Student+ ‚Ä¢ –õ–ú–°</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b0f1a;--card:rgba(255,255,255,.06);--border:rgba(255,255,255,.10);--txt:#e8ecf3;--muted:#9aa3b2;--acc1:#5b8cff;--acc2:#8a7bff;--ok:#48e39a;--warn:#ffb84d;--shadow:0 24px 70px rgba(0,0,0,.45);--radius:18px;--tfast:.25s cubic-bezier(.2,.7,.2,1);--tslow:.6s cubic-bezier(.2,.7,.2,1)}
    *{box-sizing:border-box}html,body{height:100%;margin:0}body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt);background:var(--bg)}
    .bg{position:fixed;inset:-10%;z-index:-2;filter:saturate(1.1);background:radial-gradient(1200px 900px at 10% 10%,#16213e 0%,transparent 55%),radial-gradient(900px 800px at 90% 20%,#1a2b6d 0%,transparent 55%),radial-gradient(900px 900px at 50% 100%,#261a53 0%,transparent 55%),linear-gradient(180deg,#0b0f1a 0%,#0b0f1a 100%);animation:bgfloat 16s ease-in-out infinite alternate}
    @keyframes bgfloat{to{filter:hue-rotate(18deg)}}
    .screen{position:fixed;inset:0;display:grid;place-items:center;padding:18px;opacity:0;transform:translateY(12px) scale(.985);pointer-events:none;transition:opacity var(--tslow),transform var(--tslow);min-height:100svh}
    .screen.active{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
    .card{width:min(760px,94vw);background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:28px;box-shadow:var(--shadow);backdrop-filter:blur(10px);display:grid;gap:16px;justify-items:center;text-align:center}
    .logo{display:flex;align-items:center;gap:12px}.logo-badge{width:56px;height:56px;border-radius:14px;background:conic-gradient(from 210deg,var(--acc1),var(--acc2));box-shadow:0 12px 30px rgba(91,140,255,.35);animation:spin 10s linear infinite}@keyframes spin{to{transform:rotate(1turn)}}
    .logo-title{font-weight:800;font-size:28px}.hint{color:var(--muted);font-size:13px}
    .progress{width:100%;height:10px;border-radius:8px;background:rgba(255,255,255,.06);overflow:hidden}.bar{height:100%;width:0%;background:linear-gradient(90deg,var(--acc1),var(--acc2));animation:loadbar 2.6s ease-out forwards}@keyframes loadbar{to{width:100%}}
    .cta{border:0;cursor:pointer;padding:14px 20px;border-radius:14px;color:#fff;font-weight:700;font-size:16px;background:linear-gradient(180deg,#6ea8ff,#2a74ff);box-shadow:0 16px 40px rgba(46,116,255,.35);transition:transform var(--tfast),filter var(--tfast)}
    .cta:hover{filter:brightness(1.06)}.cta:active{transform:translateY(1px) scale(.99)}.cta.alt{background:linear-gradient(180deg,#6bd69a,#2f9f6e)}
    .wrap{width:min(1100px,94vw);margin:auto;display:grid;gap:16px;grid-template-rows:auto 1fr;padding:8px 0 40px}.lib-head{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;padding:6px}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .tile{position:relative;border-radius:16px;background:var(--card);border:1px solid var(--border);padding:14px;min-height:86px;backdrop-filter:blur(8px);box-shadow:0 10px 30px rgba(0,0,0,.25);cursor:pointer;opacity:0;transform:translateY(14px) scale(.98);transition:transform var(--tfast),border-color var(--tfast),background var(--tfast)}
    .tile.in{opacity:1;transform:translateY(0) scale(1)}.tile:hover{transform:translateY(-4px) scale(1);border-color:rgba(110,168,254,.45);background:rgba(255,255,255,.08)}
    .tile h3{margin:0 0 6px 0;font-size:16px}.tile p{margin:0;color:var(--muted);font-size:12px}.chip{position:absolute;top:10px;right:10px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;background:linear-gradient(90deg,#3dc3a3,#45e39a);color:#0b1b16}
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:1000}.modal>.inner{width:min(520px,92vw);background:rgba(20,24,38,.95);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:18px;backdrop-filter:blur(8px)}
    input{font:inherit;width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.25);color:#fff}
    .steps{display:grid;gap:8px;width:100%;text-align:left}.step{display:flex;align-items:center;gap:10px}.dot{width:10px;height:10px;border-radius:999px;background:#777}.step.done .dot{background:var(--ok)}.step.active .dot{background:var(--warn)}
  </style>
</head>
<body>
  <div class="bg"></div>

  <section id="splash" class="screen active">
    <div class="card">
      <div class="logo"><div class="logo-badge"></div><div class="logo-title">Student+ MiniApp</div></div>
      <div class="progress"><div class="bar"></div></div>
      <div class="hint">–ì–æ—Ç–æ–≤–∏–º –¥–≤–∏–∂–æ–∫‚Ä¶</div>
    </div>
  </section>

  <section id="connect" class="screen">
    <div class="card">
      <h1 style="margin:6px 0 4px">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –õ–ú–°</h1>
      <div class="hint">–û–¥–∏–Ω —Ä–∞–∑ –ª–æ–≥–∏–Ω–∏–º—Å—è, —Å–æ–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã ‚Äî –¥–∞–ª—å—à–µ —Å—Ä–∞–∑—É –≤ –º–µ–Ω—é.</div>
      <button id="btnConnect" class="cta">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
    </div>
  </section>

  <section id="progress" class="screen">
    <div class="card" style="align-items:stretch">
      <h2 style="margin:4px 0 8px">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –õ–ú–°</h2>
      <div class="steps" id="steps">
        <div class="step active" data-k="launch"><div class="dot"></div><div>–ó–∞–ø—É—Å–∫ –±—Ä–∞—É–∑–µ—Ä–∞</div></div>
        <div class="step" data-k="login"><div class="dot"></div><div>–í—Ö–æ–¥ —á–µ—Ä–µ–∑ HSE SSO</div></div>
        <div class="step" data-k="courses"><div class="dot"></div><div>–ü–µ—Ä–µ—Ö–æ–¥ –≤ ¬´–ú–æ–∏ –∫—É—Ä—Å—ã¬ª</div></div>
        <div class="step" data-k="parse"><div class="dot"></div><div>–°–±–æ—Ä –∏ –æ—á–∏—Å—Ç–∫–∞</div></div>
        <div class="step" data-k="save"><div class="dot"></div><div>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞ —Ç–≤–æ–∏–º Telegram ID</div></div>
      </div>
      <div class="hint">–ü–µ—á–∞—Ç–∞–µ–º ¬´–ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏¬ª ü§´</div>
    </div>
  </section>

  <section id="library" class="screen">
    <div class="wrap">
      <div class="lib-head">
        <div><h1 style="margin:0">–¢–≤–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã</h1><div class="hint" id="meta">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</div></div>
        <div style="display:flex;gap:8px"><button id="btnReset" class="cta">–°–±—Ä–æ—Å–∏—Ç—å –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∑–∞–Ω–æ–≤–æ</button></div>
      </div>
      <div class="grid" id="grid"></div>
    </div>
  </section>

  <div id="loginModal" class="modal">
    <div class="inner">
      <h3 style="margin:0 0 10px 0">–í—Ö–æ–¥ –≤ –õ–ú–° (HSE SSO)</h3>
      <div style="display:grid;gap:8px;margin:10px 0">
        <input id="loginInput" placeholder="–õ–æ–≥–∏–Ω (email/username)">
        <input id="passInput" placeholder="–ü–∞—Ä–æ–ª—å" type="password">
      </div>
      <div style="display:flex;gap:8px">
        <button id="btnSubmitCreds" class="cta">–í–æ–π—Ç–∏ –∏ —Å–æ–±—Ä–∞—Ç—å –∫—É—Ä—Å—ã</button>
        <button id="btnCancelCreds" class="cta" style="background:linear-gradient(180deg,#666,#444)">–û—Ç–º–µ–Ω–∞</button>
      </div>
      <div class="hint" style="margin-top:8px">–ë–æ—Ç —Ç–∏—Ö–æ –ø—Ä–∏—à–ª—ë—Ç —Å—Å—ã–ª–∫—É –∏ —É–¥–∞–ª–∏—Ç –µ—ë, –º—ã –ø–æ–¥—Ö–≤–∞—Ç–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.</div>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp; try{ tg?.expand(); }catch{}
  const TG_ID = tg?.initDataUnsafe?.user?.id || 0;
  const AUTH_START_URL = "https://edu.hse.ru/login/hselogin.php";

  const s={splash:el('splash'),connect:el('connect'),progress:el('progress'),library:el('library')};
  const loginModal=el('loginModal'), loginInput=el('loginInput'), passInput=el('passInput');
  const grid=el('grid'), meta=el('meta');

  function el(id){ return document.getElementById(id); }
  function show(name){ Object.values(s).forEach(x=>x.classList.remove('active')); s[name].classList.add('active'); }
  setTimeout(()=>show('connect'), 2000);

  // ===== 1) –ü—Ä–æ–±—É–µ–º –∑–∞–±—Ä–∞—Ç—å –∫—É—Ä—Å—ã –∏–∑ hash (–±–æ—Ç –ø—Ä–∏—Å—ã–ª–∞–µ—Ç url #data=base64) =====
  (function receiveFromHash(){
    try{
      if(location.hash && location.hash.startsWith('#data=')){
        const b64 = location.hash.slice(6);
        const json = JSON.parse(new TextDecoder().decode(base64UrlToBytes(b64)));
        if(json && json.uid && Array.isArray(json.courses)){
          localStorage.setItem(`courses:${json.uid}`, JSON.stringify({ts: json.ts||Date.now(), list: json.courses}));
          // –æ—á–∏—Å—Ç–∏–º hash, —á—Ç–æ–±—ã –Ω–µ —Å–≤–µ—Ç–∏–ª—Å—è
          history.replaceState(null, '', location.pathname + location.search);
        }
      }
    }catch(e){ /* no-op */ }
  })();

  // ===== 2) –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫—É—Ä—Å—ã ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É =====
  const saved = safeGet(`courses:${TG_ID}`);
  if(saved && Array.isArray(saved.list) && saved.list.length){
    renderCourses(saved.list);
    meta.textContent = `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ‚Ä¢ ${saved.list.length} –ø—Ä–µ–¥–º–µ—Ç–æ–≤`;
    show('library');
  }

  // ===== UI actions =====
  el('btnConnect').onclick=()=>{ loginModal.style.display='grid'; loginInput.focus(); }
  el('btnCancelCreds').onclick=()=> loginModal.style.display='none';
  el('btnReset').onclick=()=>{
    localStorage.removeItem(`courses:${TG_ID}`);
    show('connect');
  };

  el('btnSubmitCreds').onclick=()=>{
    const login=(loginInput.value||'').trim();
    const password=(passInput.value||'').trim();
    if(!login||!password){ alert('–í–≤–µ–¥–∏ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å'); return; }
    loginModal.style.display='none'; show('progress');

    // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É (–≤ chat), —á—Ç–æ–±—ã –æ–Ω —Å–ø–∞—Ä—Å–∏–ª –∏ –ø—Ä–∏—Å–ª–∞–ª –Ω–∞–º —Å–∫—Ä—ã—Ç—É—é —Å—Å—ã–ª–∫—É
    const payload = { kind: "login_hse_slow", start_url: AUTH_START_URL, login, password };
    try{
      tg?.sendData?.(JSON.stringify(payload));
      // –¥–∞–ª—å—à–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–º—ë—Ç "–û—Ç–∫—Ä—ã—Ç—å –º–∏–Ω–∏-–∞–ø–ø—É" –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ (–æ–Ω–æ —É–¥–∞–ª–∏—Ç—Å—è),
      // –º—ã –ø–æ–¥—Ö–≤–∞—Ç–∏–º #data –∏ –æ–∫–∞–∂–µ–º—Å—è —Ç—É—Ç —Å –≥–æ—Ç–æ–≤—ã–º–∏ –∫—É—Ä—Å–∞–º–∏
    }catch(e){
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É: '+e.message);
      show('connect');
    }
  };

  function renderCourses(list){
    grid.innerHTML = list.map((t,i)=>`
      <div class="tile" style="animation:fadeUp .4s ease ${i*35}ms forwards">
        <div class="chip">${String(i+1).padStart(2,'0')}</div>
        <h3>${t}</h3>
        <p>–ö—É—Ä—Å —Ç–≤–æ–µ–π –û–ü</p>
      </div>`).join('');
    setTimeout(()=>document.querySelectorAll('.tile').forEach(t=>t.classList.add('in')),0);
  }

  function safeGet(k){
    try{ return JSON.parse(localStorage.getItem(k)||"null"); }catch{return null}
  }

  // base64url ‚Üí Uint8Array
  function base64UrlToBytes(b64url){
    const pad = '='.repeat((4 - b64url.length % 4) % 4);
    const b64 = (b64url + pad).replace(/-/g,'+').replace(/_/g,'/');
    const binStr = atob(b64);
    const arr = new Uint8Array(binStr.length);
    for(let i=0;i<binStr.length;i++) arr[i] = binStr.charCodeAt(i);
    return arr;
  }
</script>
</body>
</html>